const { createQuantitySelector, createSweetnessSelector, createOrderConfirmation } = require('./orderUIComponent');
const { usePoints, logPointUsage } = require('./pointComponent');
const db = require('./db');

const pendingOrders = new Map();

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
 */
async function createQuantitySelection(menuId, menuData) {
    return createQuantitySelector(menuId, menuData);
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô
 */
async function createSweetnessSelection(menuId, quantity, menuData) {
    return createSweetnessSelector(menuId, quantity, menuData);
}

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
 */
async function createOrderConfirmationMessage(orderData, db) {
    return createOrderConfirmation(orderData, db);
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏°‡∏ô‡∏π
 */
async function handleOrderRequest(menuId, db, userId) {
    try {
        const [menuRows] = await db.query('SELECT * FROM menu WHERE id = ?', [menuId]);

        if (menuRows.length === 0) {
            return {
                type: 'text',
                text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏'
            };
        }

        const menuData = menuRows[0];

        const orderSession = {
            menuId: menuId,
            menuData: menuData,
            userId: userId,
            step: 'quantity',
            timestamp: Date.now()
        };

        pendingOrders.set(userId, orderSession);

        return await createQuantitySelection(menuId, menuData);

    } catch (error) {
        console.error('Error handling order request:', error);
        return {
            type: 'text',
            text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠'
        };
    }
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
 */
async function handleQuantitySelection(userId, quantity) {
    try {
        const orderSession = pendingOrders.get(userId);

        if (!orderSession || orderSession.step !== 'quantity') {
            return {
                type: 'text',
                text: '‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà'
            };
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ quantity ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0
        if (!Number.isInteger(quantity) || quantity <= 0) {
            return {
                type: 'text',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0'
            };
        }

        orderSession.quantity = quantity;
        orderSession.step = 'sweetness';
        pendingOrders.set(userId, orderSession);

        return await createSweetnessSelection(
            orderSession.menuId,
            quantity,
            orderSession.menuData
        );

    } catch (error) {
        console.error('Error handling quantity selection:', error);
        return {
            type: 'text',
            text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô'
        };
    }
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô
 */
async function handleSweetnessSelection(userId, sweetness, db) {
    try {
        const orderSession = pendingOrders.get(userId);

        if (!orderSession || orderSession.step !== 'sweetness') {
            return {
                type: 'text',
                text: '‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà'
            };
        }

        const orderData = {
            menuId: orderSession.menuId,
            menuName: orderSession.menuData.name,
            menuPrice: Number(orderSession.menuData.price),
            menuImage: orderSession.menuData.image_url,
            quantity: orderSession.quantity,
            sweetness: sweetness,
            totalPrice: Number(orderSession.menuData.price) * orderSession.quantity,
            userId: userId
        };

        orderSession.orderData = orderData;
        orderSession.step = 'confirmation';
        pendingOrders.set(userId, orderSession);

        return await createOrderConfirmationMessage(orderData, db);

    } catch (error) {
        console.error('Error handling sweetness selection:', error);
        return {
            type: 'text',
            text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô'
        };
    }
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
 */
async function handleOrderConfirmation(userId, db, pointsToUse = 0) {
    try {
        const orderSession = pendingOrders.get(userId);

        if (!orderSession || orderSession.step !== 'confirmation') {
            return {
                type: 'text',
                text: '‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà'
            };
        }

        const orderData = orderSession.orderData;

        const [userRows] = await db.query('SELECT * FROM users WHERE line_id = ?', [userId]);
        if (!userRows.length) {
            return {
                type: 'text',
                text: '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠'
            };
        }

        let finalPrice = orderData.totalPrice;
        let pointsUsed = 0;
        let remainingPoints = userRows[0].points;

        // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°
        if (pointsToUse > 0) {
            const pointResult = await usePoints(userId, orderData.totalPrice, pointsToUse);
            if (!pointResult.success) {
                return {
                    type: 'text',
                    text: pointResult.message
                };
            }
            pointsUsed = pointResult.pointsUsed;
            finalPrice = pointResult.finalPrice;
            remainingPoints = pointResult.remainingPoints;
        }

        const [result] = await db.query(
            'INSERT INTO orders (user_id, menu_id, quantity, sweetness_level, total_price, points_used, status, order_date) VALUES (?, ?, ?, ?, ?, ?, ?, NOW())',
            [userId, orderData.menuId, orderData.quantity, orderData.sweetness, finalPrice, pointsUsed, 'pending']
        );

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö (1 ‡πÅ‡∏ï‡πâ‡∏°‡∏ï‡πà‡∏≠ 50 ‡∏ö‡∏≤‡∏ó‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏à‡∏£‡∏¥‡∏á)
        const pointsEarned = Math.floor(finalPrice / 50);

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏ï‡πâ‡∏°‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á users
        await db.query(
            'UPDATE users SET points = points + ? WHERE line_id = ?',
            [pointsEarned, userId]
        );

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ï‡πâ‡∏° (‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö)
        await db.query(
            'INSERT INTO point_history (user_id, order_id, points_earned, description, created_at) VALUES (?, ?, ?, ?, NOW())',
            [userId, result.insertId, pointsEarned, `‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${pointsEarned} ‡πÅ‡∏ï‡πâ‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ${orderData.menuName} (${orderData.quantity} ‡πÅ‡∏Å‡πâ‡∏ß)`]
        );

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        if (pointsUsed > 0) {
            await logPointUsage(
                userId,
                result.insertId,
                pointsUsed,
                `‡πÉ‡∏ä‡πâ ${pointsUsed} ‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ${orderData.menuName} (${orderData.quantity} ‡πÅ‡∏Å‡πâ‡∏ß)`
            );
        }

        pendingOrders.delete(userId);

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏ï‡πâ‡∏°
        const replyText = `‚úÖ ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n` +
            `üçµ ${orderData.menuName}\n` +
            `üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${orderData.quantity} ‡πÅ‡∏Å‡πâ‡∏ß\n` +
            `üçØ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô: ${orderData.sweetness}\n` +
            `${pointsUsed > 0 ? `üéØ ‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°: ${pointsUsed} ‡πÅ‡∏ï‡πâ‡∏°\n` : ''}` +
            `üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°: ‡∏ø${finalPrice.toFixed(2)}\n` +
            `üéâ ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${pointsEarned} ‡πÅ‡∏ï‡πâ‡∏°!\n` +
            `üéØ ‡πÅ‡∏ï‡πâ‡∏°‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${remainingPoints + pointsEarned} ‡πÅ‡∏ï‡πâ‡∏°\n\n` +
            `üìû ‡∏£‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤`;

        return {
            type: 'text',
            text: replyText
        };

    } catch (error) {
        console.error('Error confirming order:', error);
        return {
            type: 'text',
            text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠'
        };
    }
}

/**
 * ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
 */
async function handleOrderCancel(userId) {
    pendingOrders.delete(userId);
    return {
        type: 'text',
        text: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
    };
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function isOrderCommand(text) {
    return text.toLowerCase().startsWith('order ');
}

/**
 * ‡∏î‡∏∂‡∏á menu ID ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
 */
function extractMenuId(text) {
    const match = text.match(/order (\d+)/i);
    return match ? parseInt(match[1]) : null;
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function isQuantitySelection(text) {
    return text.toLowerCase().startsWith('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô');
}

/**
 * ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
 */
function extractQuantity(text) {
    const match = text.match(/‡∏à‡∏≥‡∏ô‡∏ß‡∏ô\s*(\d+)\s*‡πÄ‡πÄ‡∏Å‡πâ‡∏ß/i);
    return match ? parseInt(match[1]) : null;
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function isSweetnessSelection(text) {
    return text.toLowerCase().startsWith('‡∏´‡∏ß‡∏≤‡∏ô');
}

/**
 * ‡∏î‡∏∂‡∏á‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
 */
function extractSweetness(text) {
    const match = text.match(/‡∏´‡∏ß‡∏≤‡∏ô(.+)/i);
    return match ? match[1] : null;
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°
 */
function isOrderConfirm(text) {
    return text.toLowerCase() === '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå' || text.toLowerCase().startsWith('‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°');
}

/**
 * ‡∏î‡∏∂‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
 */
function extractPointsToUse(text) {
    const match = text.match(/‡πÉ‡∏ä‡πâ‡πÅ‡∏ï‡πâ‡∏°\s*(\d+)/i);
    return match ? parseInt(match[1]) : 0;
}

/**
 * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
 */
function isOrderCancel(text) {
    return text.toLowerCase() === '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå';
}

/**
 * ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÄ‡∏ã‡∏™‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ó‡∏∏‡∏Å 30 ‡∏ô‡∏≤‡∏ó‡∏µ)
 */
function cleanExpiredSessions() {
    const now = Date.now();
    const expirationTime = 30 * 60 * 1000; // 30 ‡∏ô‡∏≤‡∏ó‡∏µ

    for (const [userId, session] of pendingOrders.entries()) {
        if (now - session.timestamp > expirationTime) {
            pendingOrders.delete(userId);
        }
    }
}

setInterval(cleanExpiredSessions, 30 * 60 * 1000);

module.exports = {
    handleOrderRequest,
    handleQuantitySelection,
    handleSweetnessSelection,
    handleOrderConfirmation,
    handleOrderCancel,
    isOrderCommand,
    extractMenuId,
    isQuantitySelection,
    extractQuantity,
    isSweetnessSelection,
    extractSweetness,
    isOrderConfirm,
    extractPointsToUse,
    isOrderCancel
};